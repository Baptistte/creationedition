<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Devis - CRM Admin</title>
    <link rel="stylesheet" href="./assets/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h1>üé® CRM</h1>
            </div>
            <nav class="sidebar-nav">
                <a href="./dashboard.html" class="nav-item">
                    <span class="nav-item-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="./messages.html" class="nav-item">
                    <span class="nav-item-icon">üì¨</span>
                    <span>Messages</span>
                </a>
                <a href="./clients.html" class="nav-item">
                    <span class="nav-item-icon">üë•</span>
                    <span>Clients</span>
                </a>
                <a href="./devis.html" class="nav-item active">
                    <span class="nav-item-icon">üìù</span>
                    <span>Devis</span>
                </a>
                <a href="./agenda.html" class="nav-item">
                    <span class="nav-item-icon">üìÖ</span>
                    <span>Agenda</span>
                </a>
                <div class="nav-item" onclick="handleLogout()">
                    <span class="nav-item-icon">üö™</span>
                    <span>D√©connexion</span>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1 class="page-title">Devis</h1>
                <button class="btn btn-primary" onclick="alert('Fonctionnalit√© en d√©veloppement')">+ Nouveau devis</button>
            </header>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>N¬∞ Devis</th>
                            <th>Client</th>
                            <th>Titre</th>
                            <th>Montant HT</th>
                            <th>Montant TTC</th>
                            <th>Statut</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="devisTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div class="loading"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script type="module">
        import { AuthManager, ApiClient } from './assets/js/auth.js';
        await AuthManager.requireAuth();

        window.handleLogout = () => {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                AuthManager.logout();
            }
        };

        async function loadDevis() {
            try {
                const data = await ApiClient.getDevis();
                const tableBody = document.getElementById('devisTable');

                if (!data.devis || data.devis.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: var(--gray-500);">
                                Aucun devis pour le moment.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tableBody.innerHTML = data.devis.map(item => {
                    const devis = item.devis;
                    const client = item.client;
                    const statutBadge = {
                        'brouillon': '<span class="badge badge-info">Brouillon</span>',
                        'envoye': '<span class="badge badge-warning">Envoy√©</span>',
                        'accepte': '<span class="badge badge-success">Accept√©</span>',
                        'refuse': '<span class="badge badge-danger">Refus√©</span>',
                        'expire': '<span class="badge badge-danger">Expir√©</span>',
                    }[devis.statut] || devis.statut;

                    return `
                        <tr>
                            <td><strong>${devis.numeroDevis}</strong></td>
                            <td>${client ? `${client.nom} ${client.prenom || ''}` : 'N/A'}</td>
                            <td>${devis.titre}</td>
                            <td>${parseFloat(devis.montantHT).toFixed(2)} ‚Ç¨</td>
                            <td>${parseFloat(devis.montantTTC).toFixed(2)} ‚Ç¨</td>
                            <td>${statutBadge}</td>
                            <td>${new Date(devis.dateCreation).toLocaleDateString('fr-FR')}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur chargement devis:', error);
            }
        }

        loadDevis();
    </script>
</body>
</html>

