<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Projets - CRM Admin</title>
    <link rel="stylesheet" href="./assets/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h1>üé® CRM</h1>
            </div>
            <nav class="sidebar-nav">
                <a href="./dashboard.html" class="nav-item">
                    <span class="nav-item-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="./clients.html" class="nav-item">
                    <span class="nav-item-icon">üë•</span>
                    <span>Clients</span>
                </a>
                <a href="./devis.html" class="nav-item">
                    <span class="nav-item-icon">üìù</span>
                    <span>Devis</span>
                </a>
                <a href="./projets.html" class="nav-item active">
                    <span class="nav-item-icon">üöÄ</span>
                    <span>Projets</span>
                </a>
                <a href="./factures.html" class="nav-item">
                    <span class="nav-item-icon">üí∞</span>
                    <span>Factures</span>
                </a>
                <div class="nav-item" onclick="handleLogout()">
                    <span class="nav-item-icon">üö™</span>
                    <span>D√©connexion</span>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1 class="page-title">Projets</h1>
                <button class="btn btn-primary" onclick="alert('Fonctionnalit√© en d√©veloppement')">+ Nouveau projet</button>
            </header>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Client</th>
                            <th>Type</th>
                            <th>Statut</th>
                            <th>Date d√©but</th>
                            <th>Date fin</th>
                        </tr>
                    </thead>
                    <tbody id="projetsTable">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="loading"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script type="module">
        import { AuthManager, ApiClient } from './assets/js/auth.js';
        await AuthManager.requireAuth();

        window.handleLogout = () => {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                AuthManager.logout();
            }
        };

        async function loadProjets() {
            try {
                const data = await ApiClient.getProjets();
                const tableBody = document.getElementById('projetsTable');

                if (!data.projets || data.projets.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-500);">
                                Aucun projet pour le moment.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tableBody.innerHTML = data.projets.map(item => {
                    const projet = item.projet;
                    const client = item.client;
                    const statutBadge = {
                        'en-cours': '<span class="badge badge-warning">En cours</span>',
                        'termine': '<span class="badge badge-success">Termin√©</span>',
                        'annule': '<span class="badge badge-danger">Annul√©</span>',
                    }[projet.statut] || projet.statut;

                    return `
                        <tr>
                            <td><strong>${projet.titre}</strong></td>
                            <td>${client ? `${client.nom} ${client.prenom || ''}` : 'N/A'}</td>
                            <td>${projet.typeProjet}</td>
                            <td>${statutBadge}</td>
                            <td>${new Date(projet.dateDebut).toLocaleDateString('fr-FR')}</td>
                            <td>${projet.dateFin ? new Date(projet.dateFin).toLocaleDateString('fr-FR') : '-'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur chargement projets:', error);
            }
        }

        loadProjets();
    </script>
</body>
</html>

